name: Generate and Upload Videos

on:
  workflow_dispatch:
    inputs:
      topics_file:
        description: 'Path to the topics file'
        required: true
        default: 'topics.txt'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg imagemagick
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create config.toml
      run: |
        echo '[app]' > config.toml
        echo 'video_source = "pexels"' >> config.toml
        echo 'pexels_api_keys = ["${{ secrets.PEXELS_API_KEY }}"]' >> config.toml
        echo 'llm_provider = "gemini"' >> config.toml
        echo 'gemini_api_key = "${{ secrets.GEMINI_API_KEY }}"' >> config.toml
        echo 'gemini_model_name = "gemini-1.5-pro-latest"' >> config.toml
        echo 'subtitle_provider = "edge"' >> config.toml
        echo '' >> config.toml
        echo '[azure]' >> config.toml
        echo 'speech_key = "${{ secrets.AZURE_SPEECH_KEY }}"' >> config.toml
        echo 'speech_region = "${{ secrets.AZURE_SPEECH_REGION }}"' >> config.toml

    - name: Start Server
      run: |
        uvicorn main:app --host 0.0.0.0 --port 8080 &
        sleep 15 # Give the server a moment to initialize

    - name: Run video generator client
      id: video_generator # Add an ID to reference the outputs
      run: |
        python run_video_generator.py ${{ github.event.inputs.topics_file }}

    - name: Stop Server
      if: always() # Ensure this step runs even if the previous steps fail
      run: |
        pkill -f "uvicorn" || echo "Server already stopped."

    - name: Upload to YouTube
      env:
        YOUTUBE_CREDENTIALS: ${{ secrets.YOUTUBE_CREDENTIALS }}
      run: |
        python youtube_uploader.py \
          --video-path "${{ steps.video_generator.outputs.video_path }}" \
          --title "${{ steps.video_generator.outputs.video_title }}" \
          --description "AI-generated video about ${{ steps.video_generator.outputs.video_title }}. Created with MoneyPrinterTurbo." \
          --privacy-status "private"
        
# =================================================================================================
#
#  README FOR THIS WORKFLOW
#
#  This GitHub Action automates video generation and uploading to YouTube.
#
#  ** ⚠️ SETUP REQUIRED ⚠️ **
#
#  You MUST configure the following secrets in your GitHub repository's settings
#  (Settings > Secrets and variables > Actions) for this workflow to function.
#
#  ** 1. Core Service Secrets: **
#
#     - `PEXELS_API_KEY`: Your API key from Pexels.com for stock video footage.
#     - `GEMINI_API_KEY`: Your Google AI Studio API key for the language model (e.g., Gemini 1.5 Pro).
#     - `AZURE_SPEECH_KEY`: (Optional) Your Azure Speech service key for text-to-speech.
#     - `AZURE_SPEECH_REGION`: (Optional) The region for your Azure Speech service.
#
#
#  ** 2. YouTube Upload Secret (`YOUTUBE_CREDENTIALS`): **
#
#     This secret contains your Google Cloud credentials, allowing the action to upload videos
#     to your YouTube channel on your behalf.
#
#     **How to get your credentials:**
#
#     a. **Google Cloud Project:**
#        - Go to the [Google Cloud Console](https://console.cloud.google.com/).
#        - Create a new project or select an existing one.
#
#     b. **Enable YouTube Data API:**
#        - In your project, go to "APIs & Services" > "Library".
#        - Search for "YouTube Data API v3" and enable it.
#
#     c. **Configure OAuth Consent Screen:**
#        - Go to "APIs & Services" > "OAuth consent screen".
#        - Choose "External" and click "Create".
#        - Fill in the required app information (app name, user support email, developer contact).
#        - On the "Scopes" page, you do not need to add any scopes.
#        - On the "Test users" page, add the Google account associated with your YouTube channel.
#        - Save and continue.
#
#     d. **Create Credentials:**
#        - Go to "APIs & Services" > "Credentials".
#        - Click "+ CREATE CREDENTIALS" and select "OAuth client ID".
#        - Select "Desktop app" as the Application type.
#        - Give it a name (e.g., "YouTube Uploader").
#        - Click "Create". A modal will appear with your client ID and secret.
#        - Click "DOWNLOAD JSON" to save the `client_secret.json` file.
#
#     e. **Authorize the Credentials (First Time Only):**
#        - This step must be done on your local machine, not in the GitHub Action.
#        - Run the uploader action's authenticator locally. You'll need Python installed.
#          pip install google-auth-oauthlib
#          python -c "from google_auth_oauthlib.flow import InstalledAppFlow; flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', scopes=['https://www.googleapis.com/auth/youtube.upload']); flow.run_local_server()"
#        - This will print a URL. Open it in your browser.
#        - Log in with the YouTube/Google account you added as a test user.
#        - Grant the application permission to upload videos.
#        - After authorization, the local script will finish, and your `client_secret.json` will now contain a `refresh_token`.
#
#     f. **Encode and Create GitHub Secret:**
#        - You now need to convert your updated `client_secret.json` file into a single-line Base64 string.
#        - On Linux/macOS: `base64 -w 0 client_secret.json`
#        - On Windows (PowerShell): `[Convert]::ToBase64String([IO.File]::ReadAllBytes('client_secret.json'))`
#        - Copy the resulting long string.
#        - In your GitHub repository, go to Settings > Secrets and variables > Actions.
#        - Create a new secret named `YOUTUBE_CREDENTIALS` and paste the Base64 string into it.
#
# =================================================================================================